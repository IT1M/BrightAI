"use strict";const ENTERPRISE_CONFIG={apiEndpoint:"/api/ai/chat",welcomeMessage:"مرحباً بكم في Bright AI. أنا مستشاركم الذكي للحلول المؤسسية. كيف يمكنني مساعدتكم اليوم؟",placeholder:"اكتب استفسارك هنا...",title:"مستشار Bright AI",subtitle:"شريككم الاستراتيجي للتحول الرقمي",whatsappLink:"https://wa.me/966538229013",maxMessageLength:500,typingDelay:1500};class BrightAIEnterpriseChatbot{constructor(t={}){this.config={...ENTERPRISE_CONFIG,...t},this.isOpen=!1,this.isLoading=!1,this.conversationHistory=[],this.sessionId=null,this.widget=null,this.lastFocusedElement=null,this.toggle=this.toggle.bind(this),this.sendMessage=this.sendMessage.bind(this),this.handleKeyPress=this.handleKeyPress.bind(this)}init(){this.createWidget(),this.attachEventListeners(),this.addMessage(this.config.welcomeMessage,"bot")}createWidget(){this.widget=document.createElement("div"),this.widget.className="enterprise-chatbot",this.widget.setAttribute("role","region"),this.widget.setAttribute("aria-label","مستشار Bright AI المؤسسي"),this.widget.innerHTML=`\n      \x3c!-- Toggle Button --\x3e\n      <button class="enterprise-chatbot__toggle" \n              aria-label="فتح المحادثة مع مستشار Bright AI" \n              aria-expanded="false"\n              aria-controls="enterprise-chatbot-window"\n              type="button">\n        <svg class="enterprise-chatbot__toggle-icon" viewBox="0 0 24 24" aria-hidden="true">\n          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>\n          <circle cx="12" cy="10" r="1.5"/>\n          <circle cx="8" cy="10" r="1.5"/>\n          <circle cx="16" cy="10" r="1.5"/>\n        </svg>\n        <span class="enterprise-chatbot__toggle-pulse"></span>\n      </button>\n\n      \x3c!-- Chat Window --\x3e\n      <div class="enterprise-chatbot__window" \n           id="enterprise-chatbot-window"\n           role="dialog" \n           aria-labelledby="enterprise-chatbot-title"\n           aria-modal="true"\n           aria-hidden="true">\n        \n        \x3c!-- Header --\x3e\n        <header class="enterprise-chatbot__header">\n          <div class="enterprise-chatbot__header-info">\n            <div class="enterprise-chatbot__avatar">\n              <svg viewBox="0 0 24 24" aria-hidden="true">\n                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>\n              </svg>\n            </div>\n            <div class="enterprise-chatbot__header-text">\n              <h2 class="enterprise-chatbot__title" id="enterprise-chatbot-title">${this.escapeHtml(this.config.title)}</h2>\n              <span class="enterprise-chatbot__status">\n                <span class="enterprise-chatbot__status-dot"></span>\n                متصل الآن\n              </span>\n            </div>\n          </div>\n          <button class="enterprise-chatbot__close" \n                  aria-label="إغلاق المحادثة"\n                  type="button">\n            <svg viewBox="0 0 24 24" aria-hidden="true">\n              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n            </svg>\n          </button>\n        </header>\n\n        \x3c!-- Messages Area --\x3e\n        <div class="enterprise-chatbot__messages" \n             role="log" \n             aria-live="polite" \n             aria-label="سجل المحادثة"\n             tabindex="0">\n        </div>\n\n        \x3c!-- Quick Actions --\x3e\n        <div class="enterprise-chatbot__quick-actions">\n          <button type="button" class="enterprise-chatbot__quick-btn" data-message="ما هي خدماتكم؟">\n            الخدمات\n          </button>\n          <button type="button" class="enterprise-chatbot__quick-btn" data-message="أريد حجز استشارة تنفيذية">\n            استشارة\n          </button>\n          <button type="button" class="enterprise-chatbot__quick-btn" data-message="ما القطاعات التي تخدمونها؟">\n            القطاعات\n          </button>\n        </div>\n\n        \x3c!-- Input Area --\x3e\n        <footer class="enterprise-chatbot__input-area">\n          <label for="enterprise-chatbot-input" class="sr-only">اكتب استفسارك</label>\n          <input type="text" \n                 id="enterprise-chatbot-input"\n                 class="enterprise-chatbot__input" \n                 placeholder="${this.escapeHtml(this.config.placeholder)}"\n                 autocomplete="off"\n                 maxlength="${this.config.maxMessageLength}"\n                 aria-describedby="enterprise-chatbot-hint">\n          <span id="enterprise-chatbot-hint" class="sr-only">اضغط Enter لإرسال الرسالة</span>\n          <button class="enterprise-chatbot__send" \n                  aria-label="إرسال الرسالة"\n                  type="button">\n            <svg viewBox="0 0 24 24" aria-hidden="true">\n              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>\n            </svg>\n          </button>\n        </footer>\n\n        \x3c!-- WhatsApp CTA --\x3e\n        <div class="enterprise-chatbot__cta">\n          <a href="${this.config.whatsappLink}" \n             target="_blank" \n             rel="noopener noreferrer"\n             class="enterprise-chatbot__whatsapp">\n            <svg viewBox="0 0 24 24" aria-hidden="true">\n              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>\n            </svg>\n            طلب استشارة تنفيذية\n          </a>\n        </div>\n      </div>\n    `,document.body.appendChild(this.widget),this.cacheElements()}cacheElements(){this.toggleButton=this.widget.querySelector(".enterprise-chatbot__toggle"),this.chatWindow=this.widget.querySelector(".enterprise-chatbot__window"),this.messagesContainer=this.widget.querySelector(".enterprise-chatbot__messages"),this.inputField=this.widget.querySelector(".enterprise-chatbot__input"),this.sendButton=this.widget.querySelector(".enterprise-chatbot__send"),this.closeButton=this.widget.querySelector(".enterprise-chatbot__close"),this.quickButtons=this.widget.querySelectorAll(".enterprise-chatbot__quick-btn")}attachEventListeners(){this.toggleButton.addEventListener("click",this.toggle),this.closeButton.addEventListener("click",this.toggle),this.sendButton.addEventListener("click",this.sendMessage),this.inputField.addEventListener("keypress",this.handleKeyPress),this.quickButtons.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.message;e&&(this.inputField.value=e,this.sendMessage())})}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.isOpen&&this.toggle()})}toggle(){this.isOpen=!this.isOpen,this.chatWindow.classList.toggle("open",this.isOpen),this.toggleButton.classList.toggle("active",this.isOpen),this.toggleButton.setAttribute("aria-expanded",String(this.isOpen)),this.chatWindow.setAttribute("aria-hidden",String(!this.isOpen)),this.toggleButton.setAttribute("aria-label",this.isOpen?"إغلاق المحادثة":"فتح المحادثة مع مستشار Bright AI"),this.isOpen?(this.lastFocusedElement=document.activeElement,setTimeout(()=>this.inputField.focus(),100)):this.lastFocusedElement&&this.lastFocusedElement.focus()}handleKeyPress(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendMessage())}async sendMessage(){const t=this.inputField.value.trim();if(t&&!this.isLoading)if(t.length>this.config.maxMessageLength)this.showError("الرسالة طويلة جداً. الحد الأقصى هو "+this.config.maxMessageLength+" حرف.");else{this.inputField.value="",this.addMessage(t,"user"),this.setLoading(!0);try{const e=await this.callAPI(t);this.addMessage(e.reply,"bot"),e.sessionId&&(this.sessionId=e.sessionId)}catch(t){console.error("[Enterprise Chatbot] Error:",t),this.showError(t.message||"عذراً، حدث خطأ. يرجى المحاولة مرة أخرى.")}finally{this.setLoading(!1)}}}async callAPI(t){const e=await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,history:this.getHistoryForAPI(),sessionId:this.sessionId})}),s=await e.json();if(!e.ok)throw new Error(s.error||"حدث خطأ في الاتصال");return s}getHistoryForAPI(){return this.conversationHistory.slice(-10).map(t=>({text:t.text,sender:t.sender}))}addMessage(t,e){const s=new Date;this.conversationHistory.push({id:this.generateId(),text:t,sender:e,timestamp:s});const n=document.createElement("div");n.className=`enterprise-chatbot__message enterprise-chatbot__message--${e}`,n.innerHTML=`\n      <div class="enterprise-chatbot__message-content">\n        <span class="enterprise-chatbot__message-text">${this.escapeHtml(t)}</span>\n        <span class="enterprise-chatbot__message-time">${this.formatTime(s)}</span>\n      </div>\n    `,this.messagesContainer.appendChild(n),this.scrollToBottom()}showTypingIndicator(){const t=document.createElement("div");t.className="enterprise-chatbot__typing",t.id="enterprise-chatbot-typing",t.setAttribute("aria-label","يكتب الآن..."),t.innerHTML='\n      <span class="enterprise-chatbot__typing-dot"></span>\n      <span class="enterprise-chatbot__typing-dot"></span>\n      <span class="enterprise-chatbot__typing-dot"></span>\n    ',this.messagesContainer.appendChild(t),this.scrollToBottom()}hideTypingIndicator(){const t=document.getElementById("enterprise-chatbot-typing");t&&t.remove()}showError(t){const e=document.createElement("div");e.className="enterprise-chatbot__error",e.innerHTML=`\n      <span>${this.escapeHtml(t)}</span>\n      <a href="${this.config.whatsappLink}" target="_blank" rel="noopener" class="enterprise-chatbot__error-link">\n        تواصل معنا عبر واتساب\n      </a>\n    `,this.messagesContainer.appendChild(e),this.scrollToBottom()}setLoading(t){this.isLoading=t,this.sendButton.disabled=t,this.inputField.disabled=t,t?this.showTypingIndicator():this.hideTypingIndicator()}scrollToBottom(){requestAnimationFrame(()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight})}formatTime(t){return t.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})}generateId(){return`msg_${Date.now()}_${Math.random().toString(36).substring(2,11)}`}escapeHtml(t){if(window.BrightAIUtils?.escapeHtml)return window.BrightAIUtils.escapeHtml(t);const e=document.createElement("div");return e.textContent=t,e.innerHTML}clearHistory(){this.conversationHistory=[],this.messagesContainer.innerHTML="",this.addMessage(this.config.welcomeMessage,"bot"),this.sessionId=null}destroy(){this.widget?.parentNode&&this.widget.parentNode.removeChild(this.widget),this.widget=null,this.conversationHistory=[]}}function initEnterpriseChatbot(){let t=null,e=!1;const s=()=>{e||(e=!0,t=new BrightAIEnterpriseChatbot,t.init(),document.removeEventListener("scroll",n),document.removeEventListener("mousemove",n),document.removeEventListener("touchstart",n))},n=()=>{"requestIdleCallback"in window?requestIdleCallback(s):setTimeout(s,100)};document.addEventListener("scroll",n,{once:!0,passive:!0}),document.addEventListener("mousemove",n,{once:!0,passive:!0}),document.addEventListener("touchstart",n,{once:!0,passive:!0}),setTimeout(s,3e3)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initEnterpriseChatbot):initEnterpriseChatbot(),"undefined"!=typeof module&&module.exports&&(module.exports={BrightAIEnterpriseChatbot:BrightAIEnterpriseChatbot,initEnterpriseChatbot:initEnterpriseChatbot}),window.BrightAIEnterpriseChatbot=BrightAIEnterpriseChatbot;